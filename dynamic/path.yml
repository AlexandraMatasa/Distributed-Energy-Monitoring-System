http:
  # Define URL routing rules, middlewares, and services
  routers:
    user-service:
      rule: "Host(`localhost`) && PathPrefix(`/api1`)"
      entryPoints:
        - web # Listen on the web (HTTP) entry point
      service: user-service # Forward to the user service
      middlewares:
        - strip-user
        - auth-middleware

    device-service:
      rule: "Host(`localhost`) && PathPrefix(`/api2`)"
      entryPoints:
        - web # Listen on the web (HTTP) entry point
      service: device-service
      middlewares:
        - strip-device
        - auth-middleware

    auth-service-register:
      rule: "Host(`localhost`) && PathPrefix(`/api3/auth/register`)"
      entryPoints:
        - web # Listen on the web (HTTP) entry point
      service: auth-service
      middlewares:
        - strip-auth
        - auth-middleware
      priority: 100

    auth-service:
      rule: "Host(`localhost`) && PathPrefix(`/api3`)"
      entryPoints:
        - web # Listen on the web (HTTP) entry point
      service: auth-service
      middlewares:
        - strip-auth

  middlewares:
    strip-user:
      stripPrefix:
        prefixes: ["/api1"]
    strip-device:
      stripPrefix:
        prefixes: ["/api2"]
    strip-auth:
      stripPrefix:
        prefixes: [ "/api3" ]

    auth-middleware:
      forwardAuth:
        address: "http://auth-service:8083/auth/validate"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Role"
        authRequestHeaders:
          - "Authorization"

  services:
    user-service:
      loadBalancer:
        servers:
          - url: "http://user-service:8080" # Container name solved by Docker DNS

    device-service:
      loadBalancer:
        servers:
          - url: "http://device-service:8081" # Container name solved by Docker DNS

    auth-service:
      loadBalancer:
        servers:
          - url: "http://auth-service:8083" # Container name solved by Docker DNS