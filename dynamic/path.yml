http:
  # Define URL routing rules, middlewares, and services
  routers:
    user-service-docs:
      rule: "PathPrefix(`/api1/v3/api-docs`) || PathPrefix(`/api1/swagger-ui`)"
      entryPoints:
        - web
      service: user-service
      middlewares:
        - cors-headers
        - strip-user
      priority: 200

    user-service:
      rule: "PathPrefix(`/api1`)"
      entryPoints:
        - web # Listen on the web (HTTP) entry point
      service: user-service # Forward to the user service
      middlewares:
        - cors-headers
        - strip-user
        - auth-middleware
      priority: 100

    device-service-docs:
      rule: "PathPrefix(`/api2/v3/api-docs`) || PathPrefix(`/api2/swagger-ui`)"
      entryPoints:
        - web
      service: device-service
      middlewares:
        - cors-headers
        - strip-device
      priority: 200

    device-service:
      rule: "PathPrefix(`/api2`)"
      entryPoints:
        - web # Listen on the web (HTTP) entry point
      service: device-service
      middlewares:
        - cors-headers
        - strip-device
        - auth-middleware
      priority: 100

    auth-service-docs:
      rule: "PathPrefix(`/api3/v3/api-docs`) || PathPrefix(`/api3/swagger-ui`)"
      entryPoints:
        - web
      service: auth-service
      middlewares:
        - cors-headers
        - strip-auth
      priority: 300

    auth-service-register:
      rule: "PathPrefix(`/api3/auth/register`)"
      entryPoints:
        - web # Listen on the web (HTTP) entry point
      service: auth-service
      middlewares:
        - cors-headers
        - strip-auth
        - auth-middleware
      priority: 300

    auth-service:
      rule: "PathPrefix(`/api3`)"
      entryPoints:
        - web # Listen on the web (HTTP) entry point
      service: auth-service
      middlewares:
        - cors-headers
        - strip-auth
      priority: 100

    frontend:
      rule: "Host(`localhost`)"
      entryPoints:
        - web
      service: frontend

    monitoring-websocket:
      rule: "PathPrefix(`/api4/ws`)"
      entryPoints:
        - web
      service: monitoring-service-ws
      middlewares:
        - strip-monitoring
      priority: 300

    monitoring-service:
      rule: "PathPrefix(`/api4`)"
      entryPoints:
        - web
      service: monitoring-service
      middlewares:
        - cors-headers
        - strip-monitoring
        - auth-middleware
      priority: 100

  middlewares:
    cors-headers:
      headers:
        accessControlAllowOriginList:
          - "http://localhost:3000"
          - "http://localhost"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
          - "Accept"
          - "Sec-WebSocket-Extensions"
          - "Sec-WebSocket-Key"
          - "Sec-WebSocket-Version"
        accessControlAllowCredentials: true
        accessControlMaxAge: 100
        addVaryHeader: true

    strip-user:
      stripPrefix:
        prefixes: ["/api1"]
    strip-device:
      stripPrefix:
        prefixes: ["/api2"]
    strip-auth:
      stripPrefix:
        prefixes: [ "/api3" ]
    strip-monitoring:
      stripPrefix:
        prefixes: [ "/api4" ]

    auth-middleware:
      forwardAuth:
        address: "http://auth-service:8083/auth/validate"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Role"
        authRequestHeaders:
          - "Authorization"

  services:
    user-service:
      loadBalancer:
        servers:
          - url: "http://user-service:8080" # Container name solved by Docker DNS

    device-service:
      loadBalancer:
        servers:
          - url: "http://device-service:8081" # Container name solved by Docker DNS

    auth-service:
      loadBalancer:
        servers:
          - url: "http://auth-service:8083" # Container name solved by Docker DNS

    monitoring-service:
      loadBalancer:
        servers:
          - url: "http://monitoring-service:8084" # Container name solved by Docker DNS

    monitoring-service-ws:
      loadBalancer:
        servers:
          - url: "http://monitoring-service:8084"
        passHostHeader: true

    frontend:
      loadBalancer:
        servers:
          - url: "http://frontend:80"